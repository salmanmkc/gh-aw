name: Bot Detection
description: "Detect potential bots by analyzing comment similarity. DOI: https://doi.org/10.1145/3387940.3391503"

on:
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * *"  # daily

permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  detect-bots:
    runs-on: ubuntu-latest
    steps:
      - name: Detect brand new accounts with suspicious activity
        uses: actions/github-script@v7
        with:
          script: |
            const DAYS_BACK = 3;
            const MAX_PR = 200;
            const MIN_ACCOUNT_AGE_DAYS = 7;

            const cutoff = new Date(Date.now() - DAYS_BACK * 24 * 60 * 60 * 1000);

            console.log(`üîç Scanning for new accounts created in last ${MIN_ACCOUNT_AGE_DAYS} days...`);
            console.log(`üìä Checking ${MAX_PR} most recent PRs...`);

            // Fetch recent PRs
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              sort: 'updated',
              direction: 'desc',
              per_page: 100,
            });

            const highRiskAccounts = new Map();
            const commentsByUser = new Map();
            const userCreatedDates = new Map();

            console.log(`\nüìù Fetching comments from ${Math.min(prs.length, MAX_PR)} PRs...`);

            for (const pr of prs.slice(0, MAX_PR)) {
              if (new Date(pr.updated_at) < cutoff) continue;

              const { data: issueComments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
              });

              const { data: reviewComments } = await github.rest.pulls.listReviewComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
              });

              for (const comment of [...issueComments, ...reviewComments]) {
                const login = comment.user?.login;
                if (!login) continue;

                if (!userCreatedDates.has(login)) {
                  try {
                    const { data: userInfo } = await github.rest.users.getByUsername({ username: login });
                    userCreatedDates.set(login, new Date(userInfo.created_at));
                  } catch (e) {
                    userCreatedDates.set(login, null);
                  }
                }

                if (!commentsByUser.has(login)) {
                  commentsByUser.set(login, []);
                }
                commentsByUser.get(login).push({
                  pr: pr.number,
                  url: comment.html_url,
                  timestamp: comment.created_at,
                });
              }
            }

            // Identify high-risk accounts
            const now = new Date();
            for (const [login, createdDate] of userCreatedDates) {
              if (!createdDate) continue;

              const daysOld = Math.floor((now - createdDate) / (24 * 60 * 60 * 1000));
              if (daysOld < MIN_ACCOUNT_AGE_DAYS) {
                highRiskAccounts.set(login, {
                  daysOld,
                  comments: commentsByUser.get(login) || [],
                  issues: [],
                  prs: [],
                });
              }
            }

            if (highRiskAccounts.size === 0) {
              console.log('\n‚úÖ No high-risk accounts detected. Skipping report.');
              return;
            }

            console.log(`\nüö® Found ${highRiskAccounts.size} high-risk account(s)`);

            // Fetch additional activity for high-risk accounts
            for (const [login, data] of highRiskAccounts) {
              console.log(`  üìä Fetching activity for @${login}...`);

              try {
                const { data: issues } = await github.rest.issues.listByRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  creator: login,
                  state: 'all',
                });
                data.issues = issues.map(i => ({
                  number: i.number,
                  title: i.title,
                  created_at: i.created_at,
                  html_url: i.html_url,
                }));
              } catch (e) {
                console.log(`  ‚ö†Ô∏è Could not fetch issues for ${login}`);
              }

              try {
                const { data: prList } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'all',
                  per_page: 100,
                });
                data.prs = prList
                  .filter(p => p.user?.login === login)
                  .map(p => ({
                    number: p.number,
                    title: p.title,
                    created_at: p.created_at,
                    html_url: p.html_url,
                  }));
              } catch (e) {
                console.log(`  ‚ö†Ô∏è Could not fetch PRs for ${login}`);
              }
            }

            // Build report
            const today = new Date().toISOString().split('T')[0];
            let body = `# üö® HIGH RISK: Brand New Accounts Detected ‚Äî ${today}\n\n`;
            body += `Recently-created accounts often indicate bots, spam accounts, or coordinated attacks.\n\n`;

            const sorted = Array.from(highRiskAccounts.entries()).sort((a, b) => a[1].daysOld - b[1].daysOld);

            for (const [login, data] of sorted) {
              body += `## @${login}\n`;
              body += `**Account age:** ${data.daysOld} day(s) old\n\n`;

              if (data.issues && data.issues.length > 0) {
                body += `### Issues Opened (${data.issues.length})\n`;
                for (const issue of data.issues) {
                  body += `‚Ä¢ ${issue.html_url} (${issue.created_at})\n`;
                }
                body += `\n`;
              }

              if (data.prs && data.prs.length > 0) {
                body += `### Pull Requests Opened (${data.prs.length})\n`;
                for (const pr of data.prs) {
                  body += `‚Ä¢ ${pr.html_url} (${pr.created_at})\n`;
                }
                body += `\n`;
              }

              if (data.comments && data.comments.length > 0) {
                body += `### Comments (${data.comments.length})\n`;
                for (const comment of data.comments.slice(0, 10)) {
                  body += `‚Ä¢ ${comment.url} (${comment.timestamp})\n`;
                }
                if (data.comments.length > 10) {
                  body += `- ... and ${data.comments.length - 10} more comments\n`;
                }
                body += `\n`;
              }

              if (!data.issues?.length && !data.prs?.length && !data.comments?.length) {
                body += `*(No issues, PRs, or comments in the last ${DAYS_BACK} days)*\n\n`;
              }
            }

            console.log('\nüì§ Creating security alert issue...');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® HIGH RISK: Brand New Accounts ‚Äî ${today}`,
              body,
              labels: ['security', 'bot-detection'],
            });

            console.log('‚úÖ Report created successfully');
